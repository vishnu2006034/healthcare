<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hospital Analytics</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg:#0b1221;--card:#121a2b;--muted:#b7c0d1;--accent:#7dd3fc;--ok:#22c55e;--danger:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1221 0%, #10172a 100%);color:#e5e7eb}
    header{padding:24px 20px 8px}
    h1{margin:0;font-weight:800;letter-spacing:-.02em}
    .wrap{max-width:1100px;margin:0 auto;padding:12px 20px 40px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));backdrop-filter: blur(6px);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:16px;min-height:300px;display:flex;flex-direction:column}
    .card h2{margin:0 0 10px 0;font-size:16px;font-weight:700;color:#f3f4f6}
    .toolbar{display:flex;gap:10px;align-items:center;margin-bottom:8px}
    button{cursor:pointer;border:1px solid rgba(255,255,255,.12);background:#0f172a;color:#e5e7eb;padding:6px 10px;border-radius:8px;font-size:13px}
    button:disabled{opacity:.6;cursor:not-allowed}
    .status{font-size:12px;color:var(--muted)}
    canvas{flex:1;max-height:180px !important}
    .table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
    .table th,.table td{border-bottom:1px solid rgba(255,255,255,.08);padding:6px;text-align:left}
    .table tbody tr:nth-child(odd){background:rgba(255,255,255,.03)}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(125,211,252,.15);border:1px solid rgba(125,211,252,.35);color:#e0f2fe;font-size:12px}
    .error{color:var(--danger)}
  </style>
</head>
<body>
  <header class="wrap">
    <h1>Hospital Analytics</h1>
    <!-- <div class="row"><span class="chip">/analytics/patients-per-department</span><span class="chip">/analytics/drugs-per-department</span><span class="chip">/analytics/top-doctors</span></div> -->
  </header>

  <main class="wrap">
    <div class="grid">
      <section class="card">
        <h2>Patients per Department</h2>
        <div class="toolbar">
          <button id="refreshPatients">Refresh</button>
          <span id="patientsStatus" class="status"></span>
        </div>
        <canvas id="patientsChart"></canvas>
        <table class="table" id="patientsTable"></table>
      </section>

      <section class="card">
        <h2>Drugs Stock by Department</h2>
        <div class="toolbar">
          <button id="refreshDrugs">Refresh</button>
          <span id="drugsStatus" class="status"></span>
        </div>
        <canvas id="drugsChart"></canvas>
        <table class="table" id="drugsTable"></table>
      </section>

      <section class="card">
        <h2>Top Doctors by Active Patients</h2>
        <div class="toolbar">
          <button id="refreshDoctors">Refresh</button>
          <span id="doctorsStatus" class="status"></span>
        </div>
        <canvas id="doctorsChart"></canvas>
        <table class="table" id="doctorsTable"></table>
      </section>
    </div>
  </main>

  <script>
    // Helpers
    function byId(id){return document.getElementById(id)}
    function status(el, msg, isError=false){el.textContent = msg; el.classList.toggle('error', !!isError)}
    function toLabelsData(obj){ const labels = Object.keys(obj||{}); const data = labels.map(k => obj[k]); return { labels, data }}
    function drawBarChart(ctx, labels, data, label, color='rgba(125,211,252,0.7)'){
      if(ctx.__chart){ctx.__chart.destroy()}
      ctx.__chart = new Chart(ctx, {
        type:'bar',
        data:{labels, datasets:[{label, data, backgroundColor:color}]},
        options:{responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true}}}
      })
    }
    function renderTable(el, obj, headers){
      const labels = Object.keys(obj||{})
      const rows = labels.map(k=>`<tr><td>${k}</td><td>${obj[k]}</td></tr>`).join('')
      el.innerHTML = `<thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>${rows}</tbody>`
    }

    // Fetchers
    async function loadJSON(url){ const r = await fetch(url); if(!r.ok) throw new Error(`HTTP ${r.status}`); return r.json() }

    async function refreshPatients(){
      const s = byId('patientsStatus'); status(s, 'Loading...')
      try{
        const data = await loadJSON('/analytics/patients-per-department')
        const {labels, data:vals} = toLabelsData(data)
        drawBarChart(byId('patientsChart'), labels, vals, 'Patients')
        renderTable(byId('patientsTable'), data, ['Department','Patients'])
        status(s, `Updated ${new Date().toLocaleTimeString()}`)
      }catch(e){ status(s, e.message, true) }
    }
    async function refreshDrugs(){
      const s = byId('drugsStatus'); status(s, 'Loading...')
      try{
        const data = await loadJSON('/analytics/drugs-per-department')
        const {labels, data:vals} = toLabelsData(data)
        drawBarChart(byId('drugsChart'), labels, vals, 'Available Stock','rgba(34,197,94,0.7)')
        renderTable(byId('drugsTable'), data, ['Department','Qty'])
        status(s, `Updated ${new Date().toLocaleTimeString()}`)
      }catch(e){ status(s, e.message, true) }
    }
    async function refreshDoctors(){
      const s = byId('doctorsStatus'); status(s, 'Loading...')
      try{
        const arr = await loadJSON('/analytics/top-doctors')
        const labels = arr.map(x=>x.name), vals = arr.map(x=>x.patients)
        drawBarChart(byId('doctorsChart'), labels, vals, 'Active Patients','rgba(239,68,68,0.7)')
        const rows = arr.map(x=>`<tr><td>${x.name}</td><td><span class="badge">${x.patients}</span></td></tr>`).join('')
        byId('doctorsTable').innerHTML = `<thead><tr><th>Doctor</th><th>Patients</th></tr></thead><tbody>${rows}</tbody>`
        status(s, `Updated ${new Date().toLocaleTimeString()}`)
      }catch(e){ status(s, e.message, true) }
    }

    byId('refreshPatients').addEventListener('click', refreshPatients)
    byId('refreshDrugs').addEventListener('click', refreshDrugs)
    byId('refreshDoctors').addEventListener('click', refreshDoctors)

    refreshPatients(); refreshDrugs(); refreshDoctors();
  </script>
</body>
</html>
