{% extends 'base.html' %}

{% block title %}Hospital Analytics{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="text-center my-4">Hospital Analytics</h1>
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card" style="height: 400px;">
                <div class="card-header">
                    <h5>Patients per Department</h5>
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between mb-2">
                        <button id="refreshPatients" class="btn btn-primary btn-sm">Refresh</button>
                        <span id="patientsStatus" class="text-muted small"></span>
                    </div>
                    <div style="flex-grow: 1; position: relative;">
                        <canvas id="patientsChart" style="height: 100%;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card" style="height: 400px;">
                <div class="card-header">
                    <h5>Patients by Age Group</h5>
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between mb-2">
                        <button id="refreshAge" class="btn btn-primary btn-sm">Refresh</button>
                        <span id="ageStatus" class="text-muted small"></span>
                    </div>
                    <div style="flex-grow: 1; position: relative;">
                        <canvas id="ageChart" style="height: 100%;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card" style="height: 400px;">
                <div class="card-header">
                    <h5>Patients Check-in vs Check-out</h5>
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between mb-2">
                        <button id="refreshStatus" class="btn btn-primary btn-sm">Refresh</button>
                        <span id="statusStatus" class="text-muted small"></span>
                    </div>
                    <div style="flex-grow: 1; position: relative;">
                        <canvas id="statusChart" style="height: 100%;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Helpers
    function byId(id){return document.getElementById(id)}
    function status(el, msg, isError=false){el.textContent = msg; el.classList.toggle('error', !!isError)}
    function toLabelsData(obj){ const labels = Object.keys(obj||{}); const data = labels.map(k => obj[k]); return { labels, data }}
    function drawBarChart(ctx, labels, data, label, color='rgba(0,123,127,0.7)'){
      if(ctx.__chart){ctx.__chart.destroy()}
      ctx.__chart = new Chart(ctx, {
        type:'bar',
        data:{labels, datasets:[{label, data, backgroundColor:color}]},
        options:{responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true}}}
      })
    }


    // Fetchers
    async function loadJSON(url){ const r = await fetch(url); if(!r.ok) throw new Error(`HTTP ${r.status}`); return r.json() }

    async function refreshPatients(){
      const s = byId('patientsStatus'); status(s, 'Loading...')
      try{
        const data = await loadJSON('/analytics/patients-per-department')
        const {labels, data:vals} = toLabelsData(data)
        drawBarChart(byId('patientsChart'), labels, vals, 'Patients')
        status(s, `Updated ${new Date().toLocaleTimeString()}`)
      }catch(e){ status(s, e.message, true) }
    }
    async function refreshAge(){
  const s = byId('ageStatus'); status(s, 'Loading...')
  try{
    const data = await loadJSON('/analytics/patients-by-age-group')
    const {labels, data:vals} = toLabelsData(data)
    drawBarChart(byId('ageChart'), labels, vals, 'Patients by Age Group','rgba(239,68,68,0.7)')
    status(s, `Updated ${new Date().toLocaleTimeString()}`)
  }catch(e){ status(s, e.message, true) }
}

byId('refreshAge').addEventListener('click', refreshAge)
refreshAge()

    async function refreshStatus(){
  const s = byId('statusStatus'); status(s, 'Loading...')
  try{
    const data = await loadJSON('/analytics/patients-checkin-status')
    const {labels, data:vals} = toLabelsData(data)
    drawBarChart(byId('statusChart'), labels, vals, 'Patients Status','rgba(239,68,68,0.7)')
    status(s, `Updated ${new Date().toLocaleTimeString()}`)
  }catch(e){ status(s, e.message, true) }
}

byId('refreshStatus').addEventListener('click', refreshStatus)
refreshStatus()

    byId('refreshPatients').addEventListener('click', refreshPatients)
    refreshPatients();
  </script>
{% endblock %}
