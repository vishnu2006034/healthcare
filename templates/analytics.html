{% extends 'base.html' %}

{% block title %}Super Admin Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="text-center my-4">Super Admin Dashboard - Overall Workflow Analytics</h1>
    <div class="row">
        <!-- Summary Cards -->
        <div class="col-md-12 mb-4">
            <div class="row">
                <div class="col-md-2">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title" id="totalPatients">0</h5>
                            <p class="card-text">Total Patients</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title" id="totalDoctors">0</h5>
                            <p class="card-text">Total Doctors</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title" id="totalDrugs">0</h5>
                            <p class="card-text">Total Drugs</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title" id="checkedIn">0</h5>
                            <p class="card-text">Currently Checked In</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title" id="checkedOut">0</h5>
                            <p class="card-text">Checked Out Today</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title" id="prescriptions">0</h5>
                            <p class="card-text">Prescriptions (Last 30 Days)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="col-md-6 mb-4">
            <div class="card" style="height: 400px;">
                <div class="card-header">
                    <h5>Patients per Department</h5>
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between mb-2">
                        <button id="refreshPatients" class="btn btn-primary btn-sm">Refresh</button>
                        <span id="patientsStatus" class="text-muted small"></span>
                    </div>
                    <div style="flex-grow: 1; position: relative;">
                        <canvas id="patientsChart" style="height: 100%;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card" style="height: 400px;">
                <div class="card-header">
                    <h5>Patients by Age Group</h5>
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between mb-2">
                        <button id="refreshAge" class="btn btn-primary btn-sm">Refresh</button>
                        <span id="ageStatus" class="text-muted small"></span>
                    </div>
                    <div style="flex-grow: 1; position: relative;">
                        <canvas id="ageChart" style="height: 100%;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card" style="height: 400px;">
                <div class="card-header">
                    <h5>Patients Check-in vs Check-out</h5>
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between mb-2">
                        <button id="refreshStatus" class="btn btn-primary btn-sm">Refresh</button>
                        <span id="statusStatus" class="text-muted small"></span>
                    </div>
                    <div style="flex-grow: 1; position: relative;">
                        <canvas id="statusChart" style="height: 100%;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card" style="height: 400px;">
                <div class="card-header">
                    <h5>Workflow Overview</h5>
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between mb-2">
                        <button id="refreshWorkflow" class="btn btn-primary btn-sm">Refresh</button>
                        <span id="workflowStatus" class="text-muted small"></span>
                    </div>
                    <div style="flex-grow: 1; position: relative;">
                        <canvas id="workflowChart" style="height: 100%;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Helpers
    function byId(id){return document.getElementById(id)}
    function status(el, msg, isError=false){el.textContent = msg; el.classList.toggle('error', !!isError)}
    function toLabelsData(obj){ const labels = Object.keys(obj||{}); const data = labels.map(k => obj[k]); return { labels, data }}
    function drawBarChart(ctx, labels, data, label, color='rgba(0,123,127,0.7)'){
      if(ctx.__chart){ctx.__chart.destroy()}
      ctx.__chart = new Chart(ctx, {
        type:'bar',
        data:{labels, datasets:[{label, data, backgroundColor:color}]},
        options:{responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true}}}
      })
    }

    // Load summary data
    async function loadSummary(){
      try{
        const data = await loadJSON('/analytics/superadmin/workflow')
        byId('totalPatients').textContent = data.total_patients
        byId('totalDoctors').textContent = data.total_doctors
        byId('totalDrugs').textContent = data.total_drugs
        byId('checkedIn').textContent = data.checked_in
        byId('checkedOut').textContent = data.checked_out
        byId('prescriptions').textContent = data.prescriptions_last_month
      }catch(e){ console.error('Error loading summary:', e) }
    }

    // Fetchers
    async function loadJSON(url){ const r = await fetch(url); if(!r.ok) throw new Error(`HTTP ${r.status}`); return r.json() }

    async function refreshPatients(){
      const s = byId('patientsStatus'); status(s, 'Loading...')
      try{
        const data = await loadJSON('/analytics/patients-per-department')
        const {labels, data:vals} = toLabelsData(data)
        drawBarChart(byId('patientsChart'), labels, vals, 'Patients')
        status(s, `Updated ${new Date().toLocaleTimeString()}`)
      }catch(e){ status(s, e.message, true) }
    }
    async function refreshAge(){
      const s = byId('ageStatus'); status(s, 'Loading...')
      try{
        const data = await loadJSON('/analytics/patients-by-age-group')
        const {labels, data:vals} = toLabelsData(data)
        drawBarChart(byId('ageChart'), labels, vals, 'Patients by Age Group','rgba(239,68,68,0.7)')
        status(s, `Updated ${new Date().toLocaleTimeString()}`)
      }catch(e){ status(s, e.message, true) }
    }

    async function refreshStatus(){
      const s = byId('statusStatus'); status(s, 'Loading...')
      try{
        const data = await loadJSON('/analytics/patients-checkin-status')
        const {labels, data:vals} = toLabelsData(data)
        drawBarChart(byId('statusChart'), labels, vals, 'Patients Status','rgba(239,68,68,0.7)')
        status(s, `Updated ${new Date().toLocaleTimeString()}`)
      }catch(e){ status(s, e.message, true) }
    }

    async function refreshWorkflow(){
      const s = byId('workflowStatus'); status(s, 'Loading...')
      try{
        const data = await loadJSON('/analytics/workflow-overview')
        const {labels, data:vals} = toLabelsData(data)
        drawBarChart(byId('workflowChart'), labels, vals, 'Workflow Steps','rgba(34,197,94,0.7)')
        status(s, `Updated ${new Date().toLocaleTimeString()}`)
      }catch(e){ status(s, e.message, true) }
    }

    // Event listeners
    byId('refreshPatients').addEventListener('click', refreshPatients)
    byId('refreshAge').addEventListener('click', refreshAge)
    byId('refreshStatus').addEventListener('click', refreshStatus)
    byId('refreshWorkflow').addEventListener('click', refreshWorkflow)

    // Initial load
    loadSummary()
    refreshPatients()
    refreshAge()
    refreshStatus()
    refreshWorkflow()
  </script>
{% endblock %}
